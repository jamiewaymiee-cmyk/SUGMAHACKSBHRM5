-- [ LIBRARY LOAD ]
local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/jamiewaymiee-cmyk/SUGMA-LIBRARY/refs/heads/main/SUGMAHACKS", true))()

-- [ SERVICES ]
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Lighting = game:GetService("Lighting")

-- [ LOCAL PLAYER ]
local Player = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

-- ==================== CONFIGURATION (LOADER COMPATIBLE) ====================

-- Helper function to safely get global variables or fallback to default
local function getConfig(name, default)
    if getgenv()[name] ~= nil then
        return getgenv()[name]
    end
    return default
end

-- Aimbot Settings
local AimbotEnabled = getConfig("AimbotEnabled", false)
local AimPart = getConfig("AimPart", "Head")
local FOVRadius = getConfig("FOVRadius", 130)
local ShowFOV = getConfig("ShowFOV", true)
local Smoothness = getConfig("Smoothness", 15)
local DeadZone = getConfig("DeadZone", 5)

-- Prediction Settings
local PredictionEnabled = getConfig("PredictionEnabled", false)
local PredictionStrength = getConfig("PredictionStrength", 6)
local CloseRangeDistance = getConfig("CloseRangeDistance", 15)

-- ESP Settings
local ESP_ENABLED = getConfig("ESP_ENABLED", false)
local ESP_OBJECTS = {}

-- Shared Scanning
local SCAN_INTERVAL = 0.5
local ValidTargets = {} 

-- Visuals Settings
local FullbrightEnabled = getConfig("FullbrightEnabled", false)
local TimeChangerValue = getConfig("TimeChangerValue", 12)

-- Aimbot Runtime
local Target = nil
local IsAiming = false
local LastTarget = nil
local LockTime = 0

-- [ DRAWING: FOV CIRCLE ]
local FOVCircle = Drawing.new("Circle")
FOVCircle.Thickness = 2
FOVCircle.Color = Color3.fromRGB(255, 0, 127)
FOVCircle.Filled = false
FOVCircle.Radius = FOVRadius
FOVCircle.Visible = false
FOVCircle.Transparency = 1

-- ==================== HELPER FUNCTIONS ====================

local function IsValidTarget(model)
	if not model or not model.Parent then return false end
	if model.Name ~= "Male" then return false end
	
	-- Check for BallSocketConstraints (Dead Check)
	for _, descendant in ipairs(model:GetDescendants()) do
		if descendant:IsA("BallSocketConstraint") then
			return false 
		end
	end
	
	-- Check for Body Parts
	local head = model:FindFirstChild("Head")
	local root = model:FindFirstChild("Root") or model:FindFirstChild("HumanoidRootPart")
	
	if not head or not root then return false end
	
	return true
end

local function isRightClickHeld()
    return UserInputService:IsMouseButtonPressed(Enum.UserInputType.MouseButton2)
end

-- ==================== ESP FUNCTIONS ====================

local function clearESP()
	for _, data in pairs(ESP_OBJECTS) do
		if data.Highlight then data.Highlight:Destroy() end
		if data.Billboard then data.Billboard:Destroy() end
	end
	table.clear(ESP_OBJECTS)
end

local function updateESP()
    if not ESP_ENABLED then return end

    -- Cleanup invalid
    for model, data in pairs(ESP_OBJECTS) do
        if not IsValidTarget(model) then
            if data.Highlight then data.Highlight:Destroy() end
            if data.Billboard then data.Billboard:Destroy() end
            ESP_OBJECTS[model] = nil
        end
    end

    -- Create new
    for _, model in ipairs(ValidTargets) do
        if not ESP_OBJECTS[model] then
            local root = model:FindFirstChild("Root") or model:FindFirstChild("HumanoidRootPart")
            if root then
                local highlight = Instance.new("Highlight")
                highlight.FillColor = Color3.fromRGB(255, 0, 0)
                highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
                highlight.FillTransparency = 0.6
                highlight.OutlineTransparency = 0
                highlight.Adornee = model
                highlight.Parent = model

                local billboard = Instance.new("BillboardGui")
                billboard.Size = UDim2.new(0, 100, 0, 40)
                billboard.StudsOffset = Vector3.new(0, 3, 0)
                billboard.AlwaysOnTop = true
                billboard.Adornee = root
                billboard.Parent = model

                local text = Instance.new("TextLabel")
                text.Size = UDim2.new(0.5, 0, 0.5, 0)
                text.BackgroundTransparency = 1
                text.TextColor3 = Color3.new(1, 1, 1)
                text.TextStrokeTransparency = 0
                text.TextScaled = true
                text.Font = Enum.Font.SourceSansBold
                text.Text = "0 studs"
                text.Parent = billboard

                ESP_OBJECTS[model] = {
                    Highlight = highlight,
                    Billboard = billboard,
                    Label = text,
                    Root = root
                }
            end
        end
    end
end

-- ==================== AIMBOT FUNCTIONS ====================

local function getClosestTarget()
    local closestPart = nil
    local shortestDistance = FOVRadius
    local mousePos = UserInputService:GetMouseLocation()
    local centerScreen = Camera.ViewportSize / 2

    if LastTarget and LastTarget.Parent and IsValidTarget(LastTarget.Parent) then
        local pos, onScreen = Camera:WorldToViewportPoint(LastTarget.Position)
        if onScreen then
            local distanceFromMouse = (Vector2.new(pos.X, pos.Y) - mousePos).Magnitude
            if distanceFromMouse <= FOVRadius * 1.5 then
                return LastTarget
            end
        end
    end

    for _, model in ipairs(ValidTargets) do
        local part = model:FindFirstChild(AimPart)
        if part then
            local pos, onScreen = Camera:WorldToViewportPoint(part.Position)
            if onScreen then
                local distanceFromCenter = (Vector2.new(pos.X, pos.Y) - centerScreen).Magnitude
                if distanceFromCenter < shortestDistance then
                    closestPart = part
                    shortestDistance = distanceFromCenter
                end
            end
        end
    end
    
    return closestPart
end

local function moveMouseToTarget(targetPos, deltaTime)
    local screenPos, onScreen = Camera:WorldToViewportPoint(targetPos)
    
    if not onScreen then return end
    
    local mousePos = UserInputService:GetMouseLocation()
    local targetScreen = Vector2.new(screenPos.X, screenPos.Y)
    
    local delta = targetScreen - mousePos
    local distance = delta.Magnitude
    
    if distance < DeadZone then return end
    
    local smoothFactor = math.min(1, (deltaTime * 60) / Smoothness)
    local moveAmount = delta * smoothFactor
    
    if moveAmount.Magnitude > distance then
        moveAmount = delta
    end
    
    if mousemoverel then
        mousemoverel(moveAmount.X, moveAmount.Y)
    elseif mousemoveabs then
        local newPos = mousePos + moveAmount
        mousemoveabs(newPos.X, newPos.Y)
    end
end

-- ==================== UI CREATION ====================

local MainGui = Library:CreateWindow("SugmaHacks - PD Edition")

-- [ TAB 1: AIMBOT ]
local CombatElements = MainGui:CreateTab("Aimbot")

CombatElements:CreateToggle("Aimbot Enabled", "AimbotToggle", AimbotEnabled, function(state) 
    AimbotEnabled = state 
end)

CombatElements:CreateDropdown("Aim Part", "AimPartDrop", {"Head", "Root"}, function(val) 
    AimPart = val 
end)

CombatElements:CreateSlider("FOV Radius", "FOVRad", 50, 800, FOVRadius, function(val) 
    FOVRadius = val 
end)

CombatElements:CreateToggle("Show FOV Circle", "ShowFOVToggle", ShowFOV, function(state) 
    ShowFOV = state 
end)

CombatElements:CreateSlider("Smoothness", "SmoothVal", 1, 20, Smoothness, function(val) 
    Smoothness = val 
end)

CombatElements:CreateSlider("DeadZone", "DeadZoneVal", 1, 20, DeadZone, function(val) 
    DeadZone = val 
end)

-- [ PREDICTION UI ]
CombatElements:CreateLabel("--- Prediction ---")

CombatElements:CreateToggle("Prediction Enabled", "PredToggle", PredictionEnabled, function(state) 
    PredictionEnabled = state 
end)

CombatElements:CreateSlider("Prediction Strength", "PredStr", 1, 20, PredictionStrength, function(val) 
    PredictionStrength = val 
end)

CombatElements:CreateSlider("Close Range Cutoff", "PredCutoff", 0, 100, CloseRangeDistance, function(val) 
    CloseRangeDistance = val 
end)


-- [ TAB 2: ESP ]
local ESPElements = MainGui:CreateTab("ESP")

ESPElements:CreateToggle("Male ESP", "MaleESP", ESP_ENABLED, function(state) 
    ESP_ENABLED = state
    if not state then 
        clearESP() 
    end
end)

-- [ TAB 3: VISUALS ]
local VisualElements = MainGui:CreateTab("Visuals")

VisualElements:CreateToggle("Fullbright", "Fullbright", FullbrightEnabled, function(state) 
    FullbrightEnabled = state 
end)

VisualElements:CreateSlider("Time Changer", "TimeVal", 0, 24, TimeChangerValue, function(val) 
    TimeChangerValue = val 
end)

MainGui:CreateConfigTab()

-- ==================== BACKGROUND LOOPS ====================

task.spawn(function()
    while true do
        local tempTargets = {}
        for _, obj in ipairs(Workspace:GetChildren()) do
            if IsValidTarget(obj) then
                table.insert(tempTargets, obj)
            end
        end
        ValidTargets = tempTargets
        
        if ESP_ENABLED then
            updateESP()
        end
        
        task.wait(SCAN_INTERVAL)
    end
end)

-- ==================== MAIN RENDER LOOP ====================

local lastFrameTime = tick()

RunService.RenderStepped:Connect(function()
    local currentTime = tick()
    local deltaTime = currentTime - lastFrameTime
    lastFrameTime = currentTime
    
    -- Sync Lib Values (Fail-safe)
    if Library.Flags["FOVRad"] then FOVRadius = Library.Flags["FOVRad"] end
    if Library.Flags["SmoothVal"] then Smoothness = Library.Flags["SmoothVal"] end
    if Library.Flags["PredStr"] then PredictionStrength = Library.Flags["PredStr"] end
    
    -- ========== VISUALS ==========
    if FullbrightEnabled then
        Lighting.ClockTime = 14
        Lighting.Brightness = 2
        Lighting.GlobalShadows = false
        Lighting.Ambient = Color3.new(1, 1, 1)
        Lighting.OutdoorAmbient = Color3.new(1, 1, 1)
    else
        Lighting.ClockTime = TimeChangerValue
        Lighting.GlobalShadows = true
    end
    
    -- ========== AIMBOT ==========
    FOVCircle.Visible = ShowFOV and AimbotEnabled
    FOVCircle.Radius = FOVRadius
    FOVCircle.Position = UserInputService:GetMouseLocation()
    
    IsAiming = AimbotEnabled and isRightClickHeld()
    
    if IsAiming then
        local targetPart = getClosestTarget()
        
        if targetPart and targetPart.Parent and IsValidTarget(targetPart.Parent) then
            Target = targetPart
            LastTarget = targetPart
            LockTime = currentTime
            FOVCircle.Color = Color3.fromRGB(0, 255, 0)
            
            -- [[ PREDICTION LOGIC ]]
            local finalPosition = targetPart.Position
            
            if PredictionEnabled then
                local root = targetPart.Parent:FindFirstChild("Root") or targetPart.Parent:FindFirstChild("HumanoidRootPart")
                if root then
                    local distance = (Camera.CFrame.Position - root.Position).Magnitude
                    
                    if distance > CloseRangeDistance then
                        local velocity = root.AssemblyLinearVelocity
                        local timeToHit = (distance / 1000) * PredictionStrength 
                        finalPosition = finalPosition + (velocity * timeToHit)
                    end
                end
            end
            
            moveMouseToTarget(finalPosition, deltaTime)
        else
            if currentTime - LockTime > 0.2 then
                Target = nil
                LastTarget = nil
            end
            FOVCircle.Color = Color3.fromRGB(255, 0, 127)
        end
    else
        FOVCircle.Color = Color3.fromRGB(255, 0, 127)
    end
    
    -- ========== ESP DISTANCE UPDATE ==========
	if ESP_ENABLED then
		local camPos = Camera.CFrame.Position
		for model, data in pairs(ESP_OBJECTS) do
            if not IsValidTarget(model) then
                if data.Highlight then data.Highlight:Destroy() end
                if data.Billboard then data.Billboard:Destroy() end
                ESP_OBJECTS[model] = nil
            else
                local dist = (camPos - data.Root.Position).Magnitude
                data.Label.Text = math.floor(dist) .. " studs"
            end
		end
	end
end)

Library:Notify("SugmaHacks", "Loaded", 5)
