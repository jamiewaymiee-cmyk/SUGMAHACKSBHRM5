-- [ LIBRARY LOAD ]
local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/jamiewaymiee-cmyk/SUGMA-LIBRARY/refs/heads/main/SUGMAHACKS", true))()

-- [ SERVICES ]
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local GuiService = game:GetService("GuiService") -- Added for pixel accuracy
local Lighting = game:GetService("Lighting")
local Camera = Workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

-- [ CONFIGURATION VIA GETGENV ]
if not getgenv().Settings then
    getgenv().Settings = {
        Aimbot = true,
        AimPart = "Head",
        FOV = 150,
        Smoothness = 6, -- Lowered default for ranked play
        ShowFOV = true,
        Prediction = true,
        PredAmount = 0.165,
        Deadzone = 1, -- Lowered deadzone for pixel accuracy
        ESP = true,
        Fullbright = false,
        AutoDistSmooth = true -- New: Adjusts smooth based on distance
    }
end

local Settings = getgenv().Settings

-- [ VARIABLES ]
local ValidTargets = {}
local Mouse = LocalPlayer:GetMouse()
local FOVCircle = Drawing.new("Circle")
local ESP_Storage = {}

-- [ SETUP FOV ]
FOVCircle.Color = Color3.fromRGB(255, 255, 255)
FOVCircle.Thickness = 1
FOVCircle.Filled = false
FOVCircle.Transparency = 1
FOVCircle.NumSides = 64

-- [ HELPER FUNCTIONS ]
local function IsAlive(model)
    if not model or not model.Parent then return false end
    local human = model:FindFirstChild("Humanoid")
    local root = model:FindFirstChild("HumanoidRootPart") or model:FindFirstChild("Root")
    local head = model:FindFirstChild("Head")
    
    if not root or not head then return false end
    if human and human.Health <= 0 then return false end
    
    -- Anti-Ragdoll/Dead Check
    for _, v in pairs(model:GetDescendants()) do
        if v:IsA("BallSocketConstraint") then return false end 
    end
    
    return true
end

local function GetClosestPlayer()
    local bestTarget = nil
    local shortestDist = Settings.FOV
    local mousePos = UserInputService:GetMouseLocation()

    for _, model in pairs(ValidTargets) do
        local part = model:FindFirstChild(Settings.AimPart)
        if part then
            -- WorldToViewportPoint returns coordinates including GUI Inset
            local posVector, onScreen = Camera:WorldToViewportPoint(part.Position)
            
            if onScreen then
                -- FIX: Subtract GUI Inset to align WorldPoint with MouseLocation
                local realPos = Vector2.new(posVector.X, posVector.Y) - GuiService:GetGuiInset()
                local dist = (realPos - mousePos).Magnitude
                
                if dist < shortestDist then
                    shortestDist = dist
                    bestTarget = part
                end
            end
        end
    end
    return bestTarget
end

-- [ TARGET SCANNER ]
task.spawn(function()
    while true do
        local temp = {}
        for _, obj in pairs(Workspace:GetChildren()) do
            if obj ~= LocalPlayer.Character and (obj.Name == "Male" or obj:FindFirstChild("Humanoid")) then
                if IsAlive(obj) then
                    table.insert(temp, obj)
                end
            end
        end
        ValidTargets = temp
        task.wait(0.5) 
    end
end)

-- [ ESP HANDLER ]
local function UpdateESP()
    for model, visuals in pairs(ESP_Storage) do
        if not model.Parent or not IsAlive(model) or not Settings.ESP then
            if visuals.Highlight then visuals.Highlight:Destroy() end
            if visuals.Text then visuals.Text:Destroy() end
            ESP_Storage[model] = nil
        end
    end

    if not Settings.ESP then return end

    for _, model in pairs(ValidTargets) do
        if not ESP_Storage[model] then
            local hl = Instance.new("Highlight")
            hl.FillColor = Color3.fromRGB(255, 0, 0)
            hl.OutlineColor = Color3.fromRGB(255, 255, 255)
            hl.FillTransparency = 0.5
            hl.Parent = model
            
            local bg = Instance.new("BillboardGui")
            bg.Adornee = model:FindFirstChild("Head")
            bg.Size = UDim2.new(0, 100, 0, 20)
            bg.StudsOffset = Vector3.new(0, 2, 0)
            bg.AlwaysOnTop = true
            bg.Parent = model
            
            local txt = Instance.new("TextLabel", bg)
            txt.BackgroundTransparency = 1
            txt.Size = UDim2.new(1, 0, 1, 0)
            txt.TextColor3 = Color3.new(1,1,1)
            txt.TextStrokeTransparency = 0
            txt.Text = model.Name
            
            ESP_Storage[model] = {Highlight = hl, Text = bg}
        end
    end
end

-- [ UI CONSTRUCTION ]
local Win = Library:CreateWindow("Pro Aim V2")

local MainTab = Win:CreateTab("Combat")
local VisualTab = Win:CreateTab("Visuals")

MainTab:CreateToggle("Enabled", "AimEnabled", Settings.Aimbot, function(v) getgenv().Settings.Aimbot = v end)
MainTab:CreateToggle("Prediction", "PredEnabled", Settings.Prediction, function(v) getgenv().Settings.Prediction = v end)
MainTab:CreateToggle("Dynamic Smooth", "AutoSmooth", Settings.AutoDistSmooth, function(v) getgenv().Settings.AutoDistSmooth = v end)

MainTab:CreateSlider("FOV Radius", "FOVSlider", 10, 500, Settings.FOV, function(v) getgenv().Settings.FOV = v end)
MainTab:CreateSlider("Smoothness", "SmoothSlider", 1, 30, Settings.Smoothness, function(v) getgenv().Settings.Smoothness = v end)
MainTab:CreateSlider("Prediction Amount", "PredSlider", 0, 1, Settings.PredAmount * 10, function(v) getgenv().Settings.PredAmount = v / 10 end)

MainTab:CreateDropdown("Aim Part", "AimPartDrop", {"Head", "HumanoidRootPart", "Torso"}, function(v) getgenv().Settings.AimPart = v end)

VisualTab:CreateToggle("ESP Enabled", "ESPEnabled", Settings.ESP, function(v) 
    getgenv().Settings.ESP = v 
    if not v then 
        for _, vis in pairs(ESP_Storage) do 
            if vis.Highlight then vis.Highlight:Destroy() end
            if vis.Text then vis.Text:Destroy() end
        end
        ESP_Storage = {}
    end
end)
VisualTab:CreateToggle("Show FOV", "FOVShow", Settings.ShowFOV, function(v) getgenv().Settings.ShowFOV = v end)
VisualTab:CreateToggle("Fullbright", "FBEnabled", Settings.Fullbright, function(v) getgenv().Settings.Fullbright = v end)

Win:CreateConfigTab()

-- [ MAIN RENDER LOOP ]
RunService.RenderStepped:Connect(function(deltaTime)
    local S = getgenv().Settings 

    -- Draw FOV
    if FOVCircle then
        FOVCircle.Visible = S.ShowFOV and S.Aimbot
        FOVCircle.Radius = S.FOV
        FOVCircle.Position = UserInputService:GetMouseLocation()
    end

    -- Fullbright
    if S.Fullbright then
        Lighting.ClockTime = 12
        Lighting.Brightness = 2
        Lighting.Ambient = Color3.new(1,1,1)
    end

    -- Update ESP
    if tick() % 0.2 < 0.05 then UpdateESP() end

    -- Aimbot Logic
    if S.Aimbot and UserInputService:IsMouseButtonPressed(Enum.UserInputType.MouseButton2) then
        local target = GetClosestPlayer()
        if target then
            local root = target.Parent:FindFirstChild("HumanoidRootPart") or target.Parent:FindFirstChild("Root")
            
            -- Calculate 3D Position
            local targetPos = target.Position
            
            -- Prediction Logic
            if S.Prediction and root then
                targetPos = targetPos + (root.Velocity * S.PredAmount)
            end

            -- Convert to Screen Space
            local posVector, onScreen = Camera:WorldToViewportPoint(targetPos)
            
            if onScreen then
                -- CRITICAL FIX: Subtract GuiInset to fix the "1 pixel off" bug
                local realTargetPos = Vector2.new(posVector.X, posVector.Y) - GuiService:GetGuiInset()
                local mousePos = UserInputService:GetMouseLocation()
                
                local dist = (realTargetPos - mousePos).Magnitude

                if dist > S.Deadzone then
                    local moveX = (realTargetPos.X - mousePos.X)
                    local moveY = (realTargetPos.Y - mousePos.Y)
                    
                    -- Dynamic Smoothness: Be snappier if target is far away (harder to hit)
                    local currentSmooth = S.Smoothness
                    
                    if S.AutoDistSmooth then
                        local distanceToPlayer = (target.Position - Camera.CFrame.Position).Magnitude
                        if distanceToPlayer > 100 then
                            -- Reduce smoothness by half at long range for precision
                            currentSmooth = math.max(1, S.Smoothness / 2)
                        end
                    end

                    -- Movement Calculation
                    -- Using DeltaTime ensures consistent speed regardless of FPS
                    local factor = math.clamp(deltaTime * (60 / currentSmooth), 0.01, 1)
                    
                    mousemoverel(moveX * factor, moveY * factor)
                end
            end
        end
    end
end)

Library:Notify("Aim Fix Loaded", "Pixel Alignment & GUI Inset Corrected", 3)
